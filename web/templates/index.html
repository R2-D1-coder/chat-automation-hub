{% extends "base.html" %}

{% block content %}
<!-- 发送队列（主要位置） -->
<div class="card mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <span>
            <i class="bi bi-list-ol me-2"></i>发送队列
            <span class="badge bg-primary ms-2" id="queue-count">0</span>
        </span>
        <div>
            <button class="btn btn-outline-secondary btn-sm me-2" onclick="clearQueue()">
                <i class="bi bi-x-circle me-1"></i>清空队列
            </button>
            <a href="{{ url_for('queue_page') }}" class="btn btn-link btn-sm p-0">查看详情</a>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 140px;">计划时间</th>
                        <th style="width: 120px;">任务</th>
                        <th style="width: 120px;">群名</th>
                        <th>消息预览</th>
                        <th style="width: 100px;">状态</th>
                    </tr>
                </thead>
                <tbody id="queue-list-main">
                    <tr>
                        <td colspan="5" class="text-center py-3 text-muted">
                            <i class="bi bi-hourglass-split me-1"></i>加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row">
    <!-- 左侧：任务列表 -->
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">
                <i class="bi bi-list-task me-2"></i>定时任务
                <small class="text-muted fs-6">({{ tasks|length }} 个)</small>
            </h4>
            <a href="{{ url_for('new_task') }}" class="btn btn-wechat">
                <i class="bi bi-plus-lg me-1"></i>新建任务
            </a>
        </div>
        
        {% if tasks %}
            {% for task in tasks %}
            <div class="card task-card mb-3 {% if not task.enabled %}disabled{% endif %}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-1">
                                {% if task.enabled %}
                                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                                {% else %}
                                    <i class="bi bi-pause-circle text-muted me-1"></i>
                                {% endif %}
                                {{ task.name }}
                            </h5>
                            
                            <div class="mb-2">
                                <span class="cron-display">
                                    <i class="bi bi-clock me-1"></i>{{ task.cron_expression | format_cron }}
                                </span>
                            </div>
                            
                            <div class="groups-list mb-2">
                                <i class="bi bi-people-fill me-1 text-muted"></i>
                                {% for group in task.groups | to_json %}
                                    <span class="group-tag">{{ group }}</span>
                                {% endfor %}
                            </div>
                            
                            <div class="text-muted small">
                                <i class="bi bi-chat-text me-1"></i>
                                {{ task.text[:50] }}{% if task.text|length > 50 %}...{% endif %}
                                {% if task.image_path %}
                                    <span class="ms-2"><i class="bi bi-image me-1"></i>含图片</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            {% if immediate_run_enabled %}
                            <form action="{{ url_for('run_task', task_id=task.id) }}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-outline-primary btn-sm" title="立即执行">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                            </form>
                            {% else %}
                            <button type="button" class="btn btn-outline-primary btn-sm" title="立即执行（需要密码）" 
                                    onclick="showPasswordModal({{ task.id }})">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            {% endif %}
                            <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-outline-secondary btn-sm" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form action="{{ url_for('toggle_task', task_id=task.id) }}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-outline-{% if task.enabled %}warning{% else %}success{% endif %} btn-sm" 
                                        title="{% if task.enabled %}禁用{% else %}启用{% endif %}">
                                    <i class="bi bi-{% if task.enabled %}pause{% else %}play{% endif %}"></i>
                                </button>
                            </form>
                            <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" class="d-inline"
                                  onsubmit="return confirm('确定要删除任务「{{ task.name }}」吗？')">
                                <button type="submit" class="btn btn-outline-danger btn-sm" title="删除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3 mb-0">暂无定时任务</p>
                    <a href="{{ url_for('new_task') }}" class="btn btn-wechat mt-3">
                        <i class="bi bi-plus-lg me-1"></i>创建第一个任务
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- 右侧：状态和日志 -->
    <div class="col-lg-4">
        <!-- 调度器状态 -->
        <div class="card mb-3">
            <div class="card-header bg-white">
                <i class="bi bi-gear-fill me-1"></i>调度器状态
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>
                        <span class="badge bg-{% if status.running %}success{% else %}danger{% endif %}">
                            {% if status.running %}运行中{% else %}已停止{% endif %}
                        </span>
                    </span>
                    <span class="text-muted">{{ status.jobs }} 个活跃任务</span>
                </div>
                
                <div class="d-grid gap-2">
                    {% if status.running %}
                        <button class="btn btn-outline-danger btn-sm" onclick="controlScheduler('stop')">
                            <i class="bi bi-stop-fill me-1"></i>停止调度器
                        </button>
                    {% else %}
                        <button class="btn btn-wechat btn-sm" onclick="controlScheduler('start')">
                            <i class="bi bi-play-fill me-1"></i>启动调度器
                        </button>
                    {% endif %}
                    <button class="btn btn-outline-secondary btn-sm" onclick="controlScheduler('reload')">
                        <i class="bi bi-arrow-clockwise me-1"></i>重新加载任务
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 白名单群组 -->
        <div class="card mb-3">
            <div class="card-header bg-white">
                <i class="bi bi-shield-check me-1"></i>白名单群组
            </div>
            <div class="card-body">
                <div class="groups-list">
                    {% for group in allowed_groups %}
                        <span class="group-tag">{{ group }}</span>
                    {% else %}
                        <span class="text-muted">未配置白名单</span>
                    {% endfor %}
                </div>
                <small class="text-muted mt-2 d-block">
                    <i class="bi bi-info-circle me-1"></i>在 config.json 中配置
                </small>
            </div>
        </div>
        
        <!-- 最近执行 -->
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-1"></i>最近执行</span>
                <a href="{{ url_for('logs') }}" class="btn btn-link btn-sm p-0">查看全部</a>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for log in logs %}
                    <li class="list-group-item py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-{% if log.status == 'success' %}check-circle-fill log-success{% else %}x-circle-fill log-failed{% endif %} me-1"></i>
                                <span class="small">{{ log.task_name }}</span>
                            </div>
                            <small class="text-muted">{{ log.executed_at | format_datetime }}</small>
                        </div>
                    </li>
                    {% else %}
                    <li class="list-group-item text-center text-muted py-3">
                        暂无执行记录
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 密码输入模态框 -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-lock me-2"></i>启用立即执行功能
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">请输入密码以启用任务的立即执行功能：</p>
                <div class="mb-3">
                    <label class="form-label">密码</label>
                    <input type="password" class="form-control" id="passwordInput" placeholder="请输入密码" autocomplete="off">
                    <div id="passwordError" class="text-danger small mt-2" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-wechat" onclick="verifyPassword()">
                    <i class="bi bi-check-lg me-1"></i>验证
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let pendingTaskId = null;

function showPasswordModal(taskId) {
    pendingTaskId = taskId;
    const modalElement = document.getElementById('passwordModal');
    const modal = new bootstrap.Modal(modalElement);
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordError').style.display = 'none';
    modal.show();
    
    // 模态框显示后聚焦输入框
    modalElement.addEventListener('shown.bs.modal', function () {
        document.getElementById('passwordInput').focus();
    }, { once: true });
}

function verifyPassword() {
    const password = document.getElementById('passwordInput').value;
    const errorDiv = document.getElementById('passwordError');
    
    if (!password) {
        errorDiv.textContent = '请输入密码';
        errorDiv.style.display = 'block';
        return;
    }
    
    fetch('/api/verify-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ password: password })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
            modal.hide();
            
            // 重新加载页面以启用按钮
            location.reload();
        } else {
            errorDiv.textContent = data.message || '密码错误';
            errorDiv.style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    })
    .catch(e => {
        errorDiv.textContent = '验证失败，请重试';
        errorDiv.style.display = 'block';
    });
}

// 支持回车键提交
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('passwordInput');
    if (passwordInput) {
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyPassword();
            }
        });
    }
});

function controlScheduler(action) {
    fetch(`/api/scheduler/${action}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            alert(data.message);
            location.reload();
        })
        .catch(e => alert('操作失败: ' + e));
}

function loadQueue() {
    fetch('/api/queue?include_completed=false')
        .then(r => r.json())
        .then(data => {
            document.getElementById('queue-count').textContent = data.pending_count;
            renderQueueListMain(data.actions);
        })
        .catch(e => console.error('加载队列失败:', e));
}

function renderQueueListMain(actions) {
    const tbody = document.getElementById('queue-list-main');
    
    if (actions.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4 text-muted">
                    <i class="bi bi-inbox me-1"></i>队列为空
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = actions.slice(0, 20).map(action => {
        const statusBadge = getStatusBadge(action.status);
        const hasImage = action.image_path ? '<i class="bi bi-image text-muted ms-1" title="含图片"></i>' : '';
        
        return `
            <tr class="${action.status === 'running' ? 'table-warning' : ''}">
                <td>
                    <i class="bi bi-clock me-1"></i>
                    ${action.scheduled_time.split(' ')[1]}
                    <br>
                    <small class="text-muted">${action.scheduled_time.split(' ')[0]}</small>
                </td>
                <td>
                    <span class="badge bg-secondary">${action.task_name}</span>
                </td>
                <td>
                    <span class="group-tag">${action.group_name}</span>
                </td>
                <td>
                    <span class="text-truncate d-inline-block" style="max-width: 300px;" title="${action.text}">
                        ${action.text}
                    </span>
                    ${hasImage}
                </td>
                <td>${statusBadge}</td>
            </tr>
        `;
    }).join('');
    
    if (actions.length > 20) {
        tbody.innerHTML += `
            <tr>
                <td colspan="5" class="text-center text-muted small py-2">
                    还有 ${actions.length - 20} 个任务...
                </td>
            </tr>
        `;
    }
}

function getStatusBadge(status) {
    const map = {
        'pending': '<span class="badge bg-info"><i class="bi bi-hourglass-split me-1"></i>等待</span>',
        'running': '<span class="badge bg-warning"><i class="bi bi-play-fill me-1"></i>执行中</span>',
        'success': '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>成功</span>',
        'failed': '<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>失败</span>'
    };
    return map[status] || status;
}

function clearQueue() {
    if (!confirm('确定要清空所有待执行的任务吗？正在执行的不会被中断。')) return;
    
    fetch('/api/queue/clear', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            alert(data.message);
            loadQueue();
        })
        .catch(e => alert('操作失败: ' + e));
}

// 页面加载时获取队列，并每 3 秒刷新一次
document.addEventListener('DOMContentLoaded', function() {
    loadQueue();
    setInterval(loadQueue, 3000);
});
</script>
{% endblock %}

